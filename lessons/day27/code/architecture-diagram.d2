direction right

// External Components
Developer [icon: user, label: "Developer"]
Internet [icon: cloud, label: "Internet"]
GitHub [icon: github, label: "GitHub Actions"]
AWS_Cloud [icon: aws-cloud, label: "AWS Cloud"]

// CI/CD Layer
CICD [label: "CI/CD Pipeline", colorMode: bold, color: blue] {
  GitRepo [icon: github, label: "Git Repository\n(dev/test/main)"]
  Actions [icon: github-actions, label: "GitHub Actions\nTerraform Workflow"]
  TFState [icon: aws-s3-bucket, label: "S3 State Bucket\n(Terraform State)"]
}

// VPC Architecture (Per Environment)
VPC [icon: aws-vpc, label: "VPC - Environment Specific\nDev: 10.0.0.0/16\nTest: 10.1.0.0/16\nProd: 10.2.0.0/16", colorMode: bold, color: orange, styleMode: plain] {

  // Public Subnets Layer
  Public_Subnets [label: "Public Subnets", colorMode: bold, color: green] {
    IGW [icon: aws-internet-gateway, label: "Internet Gateway"]
    ALB [icon: aws-application-load-balancer, label: "Application Load Balancer\n(Port 80/443)"]
    
    Public_AZ1 [icon: aws-public-subnet, label: "Public Subnet AZ1\nus-east-1a"] {
      NAT_GW [icon: aws-nat-gateway, label: "NAT Gateway"]
      EIP [icon: aws-elastic-ip, label: "Elastic IP"]
    }
    
    Public_AZ2 [icon: aws-public-subnet, label: "Public Subnet AZ2\nus-east-1b"]
  }

  // Private Subnets Layer
  Private_Subnets [label: "Private Subnets", colorMode: bold, color: red] {
    
    Private_AZ1 [icon: aws-private-subnet, label: "Private Subnet AZ1\nus-east-1a"] {
      EC2_AZ1 [icon: aws-ec2, label: "EC2 Instance"]
      Nginx_AZ1 [icon: server, label: "Nginx Web Server\nPort 80"]
    }
    
    Private_AZ2 [icon: aws-private-subnet, label: "Private Subnet AZ2\nus-east-1b"] {
      EC2_AZ2 [icon: aws-ec2, label: "EC2 Instance"]
      Nginx_AZ2 [icon: server, label: "Nginx Web Server\nPort 80"]
    }
  }
  
  // Auto Scaling & Monitoring
  Infrastructure [label: "Infrastructure Management", colorMode: bold, color: purple] {
    ASG [icon: aws-auto-scaling, label: "Auto Scaling Group\nMin:1, Desired:2, Max:5"]
    TG [icon: aws-target-group, label: "Target Group\nHealth Checks"]
    CW [icon: aws-cloudwatch, label: "CloudWatch\nAlarms & Metrics"]
  }
  
  // Security Layer
  Security [label: "Security", colorMode: bold, color: gray] {
    SG_ALB [icon: aws-security-group, label: "ALB SG\n0.0.0.0/0:80,443"]
    SG_APP [icon: aws-security-group, label: "App SG\nALBâ†’80"]
    SG_SSH [icon: aws-security-group, label: "SSH SG\n(Restricted)"]
  }
}

// Additional AWS Resources
Resources [label: "Additional Resources", colorMode: bold, color: teal] {
  S3_Bucket [icon: aws-s3-bucket, label: "S3 Bucket\n(Versioned, Encrypted)"]
  LaunchTemplate [icon: aws-launch-template, label: "Launch Template\n(User Data Script)"]
}

// ===== CI/CD WORKFLOW =====

// 1. Development Flow
Developer > GitRepo : "1. Push Code"
GitRepo > Actions : "2. Trigger Workflow"

// 2. Pipeline Stages
Actions > Actions : "3. TFLint + Trivy\nSecurity Scan"
Actions > Actions : "4. Terraform Plan"
Actions > TFState : "5. Read State"

// 3. Deployment (Approval for Prod)
Actions > VPC : "6. Terraform Apply\n(Manual Approval for Prod)"
Actions > TFState : "7. Update State"

// ===== TRAFFIC FLOWS =====

// 1. Inbound User Traffic
Developer > Internet : "HTTPS/HTTP Request"
Internet > IGW : "Route to VPC"
IGW > ALB : "Port 80/443"

// 2. ALB Security & Distribution
SG_ALB > ALB : "Control Access"
ALB > TG : "Forward to Targets"
TG > EC2_AZ1 : "Health Check + Traffic"
TG > EC2_AZ2 : "Health Check + Traffic"

// 3. Application Security
SG_APP > EC2_AZ1 : "Restrict to ALB"
SG_APP > EC2_AZ2 : "Restrict to ALB"

// 4. Container/Service Execution
EC2_AZ1 > Nginx_AZ1 : "Run Web Server"
EC2_AZ2 > Nginx_AZ2 : "Run Web Server"

// 5. Auto Scaling Management
ASG > LaunchTemplate : "Instance Config"
ASG > EC2_AZ1 : "Scale Out/In"
ASG > EC2_AZ2 : "Scale Out/In"
CW > ASG : "Trigger Scaling"

// 6. Outbound Traffic (Updates, Packages)
EC2_AZ1 > NAT_GW : "Outbound via NAT"
EC2_AZ2 > NAT_GW : "Outbound via NAT"
NAT_GW > EIP : "Public IP"
EIP > IGW : "Route Out"
IGW > Internet : "External Access"

// 7. Monitoring & Logging
EC2_AZ1 > CW : "Metrics & Logs"
EC2_AZ2 > CW : "Metrics & Logs"
ALB > CW : "ALB Metrics"

// 8. Storage Operations
EC2_AZ1 > S3_Bucket : "Read/Write (Optional)"
EC2_AZ2 > S3_Bucket : "Read/Write (Optional)"

// ===== MULTI-ENVIRONMENT ISOLATION =====

// State Management
TFState > TFState : "env:/dev/...\nenv:/test/...\nenv:/prod/..."

// Workspace Annotations
VPC : "Terraform Workspace\nIsolates Environments"
